module Test_CT

include(joinpath(@__DIR__,"..", "..", "src", "ZMPBipedRobot.jl"))
import .ZMPBipedRobot as ZMProbot
using Test, Plots

sleep(0.1) # used for good printing
println("Started test")

# If the maximal  error is bounded within -2cm and + 2cm with the ZMP generated by Preview Controller and the reference ZMP 
@testset "CoM Trajectory Generator" begin 
    br = ZMProbot.BipedRobot(;
        readFile = true,
        paramFileName = "param_test.jl",
    )
    pc = ZMProbot.PreviewController(br = br)
    fp = ZMProbot.FootPlanner(br = br)
    zt = ZMProbot.ZMPTrajectory(br = br, fp = fp)
    ct = ZMProbot.CoMTrajectory(; br = br, pc = pc, zt = zt, check = false)

    tref = reduce(vcat, zt.timeVec)
    p = reduce(hcat, ct.p)
    zmp = reduce(hcat, zt.ZMP)

    @test [isapprox(p[1, i], zmp[1, i], atol = 0.02) for i = 1 : length(p[1, :])] == ones(length(p[1, :]))
    @test [isapprox(p[2, i], zmp[2, i], atol = 0.02) for i = 1 : length(p[1, :])] == ones(length(p[1, :]))
    @test p == [0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 0.0 9.723912904543604e-23 -1.53784750295917e-6 -7.243235737782493e-6 -1.848039836666018e-5 -3.482818283811291e-5 -5.443698374692541e-5 -7.464376168163824e-5 -9.252473462299228e-5 -0.000105270176195835 -0.00011037991492094857 -0.0001075096299466003 -9.89998369590217e-5 -8.765268296404329e-5 -7.569906101328299e-5 -6.452087347834968e-5 -5.475653181096537e-5 -4.653819096255037e-5 -3.97229063741007e-5 -3.406202662282245e-5 -2.9301366822696753e-5 -2.5226670660320402e-5 -2.1674395279796155e-5 -1.852520021461651e-5 -1.5692183685283656e-5 -1.3110804851148824e-5 -1.0733605290548119e-5 -8.530216449798597e-6 -6.4910978914119524e-6 -4.631276408426912e-6 -2.9875718544670766e-6 -1.599520922546116e-6 -4.6158418969119083e-7 5.65137942757591e-7 1.8851541632152607e-6 4.326415953808532e-6 9.264076966875295e-6 1.8587571534002447e-5 3.431163057852904e-5 5.7568559229051984e-5 8.672678900673199e-5 0.00011455449957746902 0.00012481464661790505 8.956727213385411e-5 -3.0181963467630982e-5 -0.00027617590450287714 -0.0006712339972737378 -0.001178619838405965 -0.0016405350364257706 -0.0017038475379499672 -0.0007603332904409579 0.0020417824393870257 0.007620254093944387 0.016494713025481524 0.028437652993965473 0.0425271529639131 0.05738320151812725 0.07146883471968588 0.08340511516951703 0.0922725100857561 0.09784737714506526 0.10065232104713498 0.10160429270776554 0.101552263645528 0.10110222572117104 0.10060592752953597 0.10022052720549747 0.09998262682610701 0.09986954734840546 0.09983979161760947 0.09985461603731886 0.09988629091543615 0.09991873813057778 0.09994483985802509 0.09996304524760685 0.0999745439871438 0.09998138997086321 0.09998549337902694 0.09998822773920467 0.09999039303343484 0.09999234200422011 0.09999415687291593 0.09999582926200712 0.09999743673805388 0.09999932289615175 0.10000227424806793 0.10000764636009875 0.10001732587042683 0.1000333347125487 0.10005681666801841 0.10008615214429532 0.10011411983718606 0.1001244910912168 0.10008933228344997 0.0999696537481349 0.09972371610451534 0.09932870254183446 0.09882135154587361 0.09835946321316998 0.09829617102769378 0.09923970025536957 0.10204182665855505 0.10762184339396422 0.11650201222997475 0.12845619175678144 0.14256204027389005 0.15743769715380954 0.17154353573815953 0.18349769510013822 0.19237783293368227 0.19795780690369832 0.2007598775142536 0.2017033362940756 0.20163995698330656 0.20117796239197658 0.2006704830587505 0.2002753155595507 0.2000291941465265 0.19990929684483216 0.19987387785508345 0.19988393939829202 0.19991153752490157 0.19994043056695904 0.19996338135369865 0.19997875212628688 0.19998766802396295 0.19999213547428352 0.19999403428047158 0.1999947284211467 0.19999503289675788 0.1999953372615246 0.1999957632656868 0.19999629698488267 0.19999687707907066 0.1999974426280948 0.19999795218612382 0.19999838616012924 0.19999874174872412 0.19999902614966145 0.19999925083494824 0.19999942777648197 0.19999956748671952 0.19999967835115964 0.19999976670181774 0.19999983720977998 0.19999989333611676 0.19999993771412466 0.19999997242418507 0.19999999916953734 0.2000000193791305 0.20000003426488108; 1.18 1.1834408861150802 1.1830153116797184 1.1812208230064023 1.1794248090184154 1.178181041214954 1.1775668999604592 1.1774438776262586 1.1776202833132527 1.1779321397533704 1.1782696233334444 1.1785741976071027 1.178824310077851 1.179019972684766 1.179170796263485 1.1792885024716853 1.179383203535093 1.17946219960358 1.1795301354670025 1.1795896899636957 1.1796423186476557 1.179688836104252 1.1797297889832845 1.1797656517537776 1.1797969028102158 1.1798240346965214 1.179847537061265 1.179867475098864 1.179883589382523 1.1798959008089174 1.17990484476775 1.1799111817994208 1.179915843286771 1.1799197938238937 1.179923939365269 1.179929081132817 1.179935439412679 1.179942519073388 1.179949690048238 1.1799564578892818 1.1799625376603344 1.1799678279497143 1.1799723504458455 1.1799761909389903 1.1799794562480128 1.1799822490249257 1.1799846566773753 1.1799867492112954 1.1799885814855424 1.1799901967574316 1.1799916297247832 1.1799929082636003 1.1799940537425129 1.1799950803249817 1.1799959942347513 1.1799967946831873 1.1799974790078123 1.1799980552534934 1.179998565260762 1.1799991191671637 1.179999936545172 1.1800013786673686 1.180003940022925 1.1800081472477184 1.1800142971737342 1.180021967702224 1.180029280388393 1.1800320151859516 1.1800229090801235 1.1799918247340593 1.1799279100411169 1.1798252328406786 1.179693345373854 1.1795732758953459 1.17955683932236 1.179802174414226 1.1805307430399354 1.1819823612555416 1.1842941847027126 1.1874081261468001 1.191084157867059 1.1949620344173129 1.1986400681891525 1.2017574550700076 1.2040729250897024 1.2055263812314903 1.2062534322519634 1.2064943110824164 1.206471936071169 1.2063456052669157 1.2062078512473806 1.2061000331398812 1.2060317706097863 1.2059970556477118 1.2059849050787128 1.2059850473324591 1.2059901055941715 1.2059957720105998 1.2060001028805913 1.2060026272160462 1.2060036040080853 1.2060035302639023 1.2060028789535102 1.206001999761745 1.206001112412813 1.2060003373461625 1.2059997267839577 1.2059992742324805 1.2059988915218463 1.2059983524739006 1.2059972157829226 1.2059947612792252 1.2059900057324888 1.2059819033574974 1.2059698683413613 1.2059547522150793 1.2059403182608512 1.2059350119240597 1.205953363631048 1.2060156516545368 1.206143583174895 1.2063490249901418 1.206612874712549 1.206853077622392 1.2068860054243127 1.20639538192687 1.204938284536651 1.2020358818078625 1.1974152307445856 1.1911932159439547 1.1838496744700295 1.176104135952266 1.168758591281664 1.162533128705281 1.1579088274377873 1.1550045817072812 1.1535489951962516 1.1530628193175179 1.1531016746679863 1.153348125365964 1.1536178249744924 1.1538283873232584 1.1539606418963217 1.1540265304616826 1.1540478901391107 1.1540451319516316 1.1540328981654293 1.1540197194872397 1.1540094212985672 1.1540029004175705 1.1539996053270583 1.1539985173566605 1.153998674793733 1.1539993733237874 1.1540001813261247 1.1540008770798906 1.1540013767097934 1.1540016903312074 1.154001922063294 1.1540023139239337 1.154003317994959 1.1540056595402233 1.1540103225182174 1.1540183508424313 1.154030327342645 1.154045397374712 1.154059794922707 1.154065072360509 1.1540466976149404 1.1539843911983023 1.153856445029853 1.1536509916264468 1.153387132834459 1.1531469229303506 1.1531139898375489 1.1536046094320314 1.1550617040396438 1.1579633052001013 1.16258098828087 1.1687971591281778 1.1761321995505087 1.1838675416104545 1.191202579114812 1.197418744117028 1.202036418407548 1.204938007805887 1.2063950876438134 1.2068856894150375 1.2068527353867984 1.2066125013617595 1.2063486151768472 1.2061431310207 1.2060151506834307 1.2059528067248946 1.2059343913222718 1.2059396256280623 1.2059539787896576 1.205969005143554 1.2059809413667322 1.2059889358317342 1.2059935736189957 1.2059958980794054 1.2059968867194495 1.2059972488168493 1.2059974081805445 1.2059975673871806 1.2059977897549943 1.205998068051029 1.2059983703857373 1.2059986650874608 1.2059989306107197 1.2059991567730353 1.2059993421231294 1.2059994904088425 1.2059996076002109 1.2059996999268197 1.2059997728589744 1.2059998307606168 1.2059998769275564 1.2059999137916222 1.2059999431551591 1.2059999663898187 1.2059999845795049 1.2059999986117962 1.2060000092314498 1.2060000170701914]

end 

sleep(0.1) # used for good printing
println("End test")

end # End Main Module 
